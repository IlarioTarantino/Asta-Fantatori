<!DOCTYPE html>
<html lang="it" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Asta Pubblica Fantacalcio</title>
  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700;900&display=swap" rel="stylesheet" />

  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #004d00 0%, #003300 100%);
      min-height: 100vh;
    }
    /* Scrollbar personalizzata */
    .tailwind-scrollbar::-webkit-scrollbar {
      width: 12px;
    }
    .tailwind-scrollbar::-webkit-scrollbar-track {
      background: #2e4500;
    }
    .tailwind-scrollbar::-webkit-scrollbar-thumb {
      background-color: #a5d13a;
      border-radius: 75px;
      border: 3px solid #2e4500;
    }
  </style>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
</head>
<body class="relative text-green-100 flex flex-col items-center p-6 space-y-6">

  <!-- Immagini di sfondo -->
  <div class="fixed bottom-4 right-4 w-36 h-36 bg-cover bg-center opacity-20 pointer-events-none z-0"
       style="background-image: url('img/mazzone_ansa.jpg');"></div>

  <div class="fixed top-4 left-4 w-40 h-28 bg-cover bg-center opacity-20 pointer-events-none z-0"
       style="background-image: url('img/allenatore_nel_pallone_-kwlE-RexWCx4Ewisg3PzIgvdwk5N-590x445-Corriere-Web-Sezioni.jpg');"></div>

  <div id="extra-bg-image" class="fixed top-[38%] right-0 w-32 h-44 bg-cover bg-center opacity-20 pointer-events-none z-0"
       style="background-image: url('img/allegri.juve_.sorrisone.2022.1400x840.jpg');"></div>

  <h1 class="text-4xl font-extrabold text-center drop-shadow-lg tracking-wide uppercase z-10">Asta Pubblica Fantacalcio</h1>

  <section class="bg-green-900 bg-opacity-80 p-8 rounded-3xl shadow-lg w-full max-w-xl flex flex-col space-y-6 relative z-10">
    <div class="flex justify-between">
      <h2 class="text-2xl font-bold">Giocatore in asta:</h2>
      <span id="currentPlayer" class="text-2xl font-semibold italic">---</span>
    </div>
    <div class="flex justify-between items-center">
      <h2 class="text-2xl font-bold">Prezzo attuale:</h2>
      <span id="currentPrice" class="text-2xl font-semibold">1</span>
    </div>

    <div class="flex flex-wrap gap-4 justify-center">
      <button id="startAuctionBtn" class="bg-yellow-400 hover:bg-yellow-500 text-green-900 font-bold py-3 px-6 rounded-full shadow-lg transition transform hover:scale-105 disabled:opacity-50" >Avvia Asta</button>
      <button id="endBidBtn" disabled class="bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-6 rounded-full shadow-lg transition transform hover:scale-105 disabled:opacity-50">Termina Puntata</button>
    </div>

    <div class="flex space-x-2 items-center">
      <input id="bidAmount" type="number" min="1" max="500" placeholder="Importo rilancio" class="flex-grow py-3 px-5 rounded-3xl text-green-900 focus:outline-none focus:ring-4 focus:ring-yellow-400 shadow-inner" />
      <button id="placeBidBtn" class="bg-yellow-400 hover:bg-yellow-500 text-green-900 font-bold py-3 px-6 rounded-full shadow-lg transition transform hover:scale-105 disabled:opacity-50">Rilancia</button>
    </div>

    <div>
      <h3 class="text-lg font-semibold mb-2">Partecipanti attivi:</h3>
      <ul id="activeBiddersList" class="max-h-48 overflow-y-auto tailwind-scrollbar rounded-2xl bg-green-700 bg-opacity-60 p-4 space-y-1 text-green-200 font-medium"></ul>
    </div>

    <div>
      <h3 class="text-lg font-semibold mb-2">Crediti residui giocatori:</h3>
      <ul id="playersCreditsList" class="max-h-48 overflow-y-auto tailwind-scrollbar rounded-2xl bg-green-700 bg-opacity-60 p-4 space-y-1 text-green-300 font-mono"></ul>
    </div>
  </section>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCo6gqylc6AyMfZrOhVq3d0N_mN8eFcDbs",
      authDomain: "fanta-stitici.firebaseapp.com",
      databaseURL: "https://fanta-stitici-default-rtdb.firebaseio.com",
      projectId: "fanta-stitici",
      storageBucket: "fanta-stitici.appspot.com",
      messagingSenderId: "105262633208",
      appId: "1:105262633208:web:a7314cd5d016beb169ab0d"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const auctionRef = db.ref('auction');
    const biddersRef = db.ref('bidders');

    const currentPlayerSpan = document.getElementById('currentPlayer');
    const currentPriceSpan = document.getElementById('currentPrice');
    const startAuctionBtn = document.getElementById('startAuctionBtn');
    const endBidBtn = document.getElementById('endBidBtn');
    const bidAmountInput = document.getElementById('bidAmount');
    const placeBidBtn = document.getElementById('placeBidBtn');
    const activeBiddersList = document.getElementById('activeBiddersList');
    const playersCreditsList = document.getElementById('playersCreditsList');

    let userId = 'user_' + Math.floor(Math.random() * 1000000);
    const initialCredit = 500;

    function resetBidders() {
      biddersRef.set({});
    }

    auctionRef.on('value', snap => {
      const auction = snap.val() || {};
      currentPlayerSpan.textContent = auction.currentPlayer || '---';
      currentPriceSpan.textContent = auction.currentPrice || 1;
      const started = auction.started || false;

      startAuctionBtn.disabled = started;
      placeBidBtn.disabled = !started;
      bidAmountInput.disabled = !started;
      endBidBtn.disabled = !started;

      if(!started) {
        activeBiddersList.innerHTML = '';
        playersCreditsList.innerHTML = '';
      }
    });

    biddersRef.on('value', snap => {
      const bidders = snap.val() || {};
      activeBiddersList.innerHTML = '';
      playersCreditsList.innerHTML = '';
      for(let uid in bidders) {
        let item = document.createElement('li');
        item.textContent = `${uid}: ${bidders[uid].credits}`;
        playersCreditsList.appendChild(item);

        if(bidders[uid].active) {
          let activeItem = document.createElement('li');
          activeItem.textContent = uid;
          activeBiddersList.appendChild(activeItem);
        }
      }

      const actives = Object.values(bidders).filter(b => b.active);
      if(actives.length === 1 && Object.keys(bidders).length > 0) {
        auctionRef.update({ started: false });
        alert('Asta terminata! Il vincitore Ã¨ ' + Object.keys(bidders).find(k => bidders[k].active));
      }
    });

    startAuctionBtn.onclick = () => {
      const playerName = prompt('Inserisci il nome del giocatore in asta');
      if(!playerName) return alert('Serve un nome giocatore');

      auctionRef.set({
        currentPlayer: playerName,
        currentPrice: 1,
        started: true
      });

      biddersRef.set({
        [userId]: { credits: initialCredit, active: true }
      }, e => {
        if(e) alert('Errore inizializzazione bidder');
      });
    };

    placeBidBtn.onclick = () => {
      const bid = parseInt(bidAmountInput.value);
      if (isNaN(bid) || bid <= 0) {
        return alert('Inserisci un importo valido');
      }

      auctionRef.once('value').then(snap => {
        const auction = snap.val() || {};
        if(!auction.started) return alert('Asta non avviata');
        if(bid <= auction.currentPrice) return alert('Importo deve essere superiore al prezzo attuale');
        if(bid > initialCredit) return alert('Importo maggiore del credito disponibile');

        auctionRef.update({ currentPrice: bid });
        biddersRef.child(userId).once('value').then(userSnap => {
          let userData = userSnap.val() || { credits: initialCredit, active: true };
          if(bid > userData.credits) {
            alert('Crediti non sufficienti');
            return;
          }
          userData.credits -= bid;
          biddersRef.child(userId).set(userData);
          bidAmountInput.value = '';
        });
      });
    };

    endBidBtn.onclick = () => {
      biddersRef.child(userId).update({ active: false });
      alert('Hai terminato la tua partecipazione all\'asta');
    };

    window.addEventListener("beforeunload", () => {
      biddersRef.child(userId).update({ active: false });
    });
  </script>
</body>
</html>
